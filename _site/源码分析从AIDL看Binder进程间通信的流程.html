<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
        <meta name="keywords" content="源码阅读,AIDL,Binder" />
        <meta name="description" content="Binder通信是Android系统架构的基础。本文尝试从AIDL的使用开始理解系统的Binder通信。" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title> 源码分析从AIDL看Binder进程间通信的流程  </title>
        <link rel="stylesheet" href="http://localhost:4000/css/default.css" type="text/css" />
        <link rel="stylesheet" href="http://localhost:4000/css/small.css" type="text/css" media="(max-width: 720px)"/>
        <link rel="stylesheet" href="http://localhost:4000/css/syntax.css" type="text/css" />
        <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" type="image/x-icon" />
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>
    </head>
    <body>

<div class="container">
    <div class="nav">
    <div class="nav_nav">
        <a class="nav_a1" href="http://localhost:4000/">首页</a>
        <a href="http://localhost:4000/categories/">分类</a>
        <a class="nav_a1" href="http://localhost:4000/wiki/">维基</a>
        <a href="http://localhost:4000/links/">链接</a>
        <a class="nav_a1" href="http://localhost:4000/about/">关于</a>
    </div>
    <div class="nav_rss"><a href="http://localhost:4000/sitemap.xml" style="display:none;">SITEMAP</a><a href="http://localhost:4000/feed.xml" target="_blank">订阅</a></div>
</div>

    <div class="main">
        <h2> 源码分析从AIDL看Binder进程间通信的流程 </h2>
        <p><code class="highlighter-rouge">Binder</code>通信是Android系统架构的基础。本文尝试从AIDL的使用开始理解系统的<code class="highlighter-rouge">Binder</code>通信。</p>

<h3 id="0x00-一个aidl的例子">0x00 一个AIDL的例子</h3>

<p>首先我们创建一个项目，写一个<code class="highlighter-rouge">RemoteService.java</code>，并定义个<code class="highlighter-rouge">AIDL</code>接口<code class="highlighter-rouge">IRemoteService.aidl</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">IRemoteService</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">getText</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这时候IDE会自动在目录<code class="highlighter-rouge">build/generated/source/aidl/debug/</code>生成<code class="highlighter-rouge">IRemoteService.java</code>文件。</p>

<p>本文为了方便调试和理解<code class="highlighter-rouge">AIDL</code>的过程，我们把生成的<code class="highlighter-rouge">IRemoteService.java</code>文件拷贝出来，放在<code class="highlighter-rouge">app/main/java</code>目录下，然后把<code class="highlighter-rouge">aidl</code>文件夹删除。</p>

<p><code class="highlighter-rouge">RemoteService</code>为服务端，<code class="highlighter-rouge">MainActivity</code>为客户端。最后项目结构为</p>

<p><img src="../images/binder-auto-code.png" alt="最终项目结构" /></p>

<h3 id="0x01-远程服务remoteservice">0x01 远程服务RemoteService</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RemoteService</span> <span class="kd">extends</span> <span class="n">Service</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">ACTION</span> <span class="o">=</span> <span class="s">"net.angrycode.RemoteService"</span><span class="o">;</span>
    <span class="nd">@Nullable</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">IBinder</span> <span class="nf">onBind</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">mBinder</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
     * 定义远程服务对外接口
     */</span>
    <span class="n">IRemoteService</span><span class="o">.</span><span class="na">Stub</span> <span class="n">mBinder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IRemoteService</span><span class="o">.</span><span class="na">Stub</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">getText</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"text from remote,pid:"</span> <span class="o">+</span> <span class="n">Process</span><span class="o">.</span><span class="na">myPid</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">};</span>
<span class="o">}</span>
</code></pre></div></div>

<p>在<code class="highlighter-rouge">RemoteService</code>中定义<code class="highlighter-rouge">IBinder</code>接口，并在<code class="highlighter-rouge">onBind()</code>方法中返回，供客户端使用。</p>

<p>最后在<code class="highlighter-rouge">mainifest</code>文件中注册远程服务，指定进程为私有进程</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">service</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">".RemoteService"</span>
    <span class="nl">android:</span><span class="n">process</span><span class="o">=</span><span class="s">":remote"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">intent</span><span class="o">-</span><span class="n">filter</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">action</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">"net.angrycode.RemoteService"</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">intent</span><span class="o">-</span><span class="n">filter</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">service</span><span class="o">&gt;</span>
</code></pre></div></div>

<h3 id="0x02-本地客户端mainactivity">0x02 本地客户端MainActivity</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">TextView</span> <span class="n">mTextMessage</span><span class="o">;</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
        <span class="n">mTextMessage</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClickBind</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Intent</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">RemoteService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="n">RemoteService</span><span class="o">.</span><span class="na">ACTION</span><span class="o">);</span>
        <span class="n">bindService</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">conn</span><span class="o">,</span> <span class="n">Context</span><span class="o">.</span><span class="na">BIND_AUTO_CREATE</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClickUnBind</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">unbindService</span><span class="o">(</span><span class="n">conn</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">ServiceConnection</span> <span class="n">conn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServiceConnection</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceConnected</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">IRemoteService</span> <span class="n">iRemoteService</span> <span class="o">=</span> <span class="n">IRemoteService</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span><span class="c1">//连接之后获取到远程服务text</span>
                <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">iRemoteService</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
                <span class="n">mTextMessage</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getApplication</span><span class="o">(),</span> <span class="s">"远程服务已连接"</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceDisconnected</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getApplication</span><span class="o">(),</span> <span class="s">"远程服务已断开"</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">};</span>
<span class="o">}</span>
</code></pre></div></div>

<p>本地客户端实现了<code class="highlighter-rouge">ServiceConnection</code>接口，用于监听远程服务的连接状态，并在<code class="highlighter-rouge">onServiceConnected()</code>中拿到远程服务<code class="highlighter-rouge">RemoteService</code>对外的接口<code class="highlighter-rouge">IRemoteService</code>的引用。</p>

<p>当客户端进行绑定远程服务时，就使用<code class="highlighter-rouge">IRemoteService.Stub.asInterface(IBinder)</code>获取到远程服务对象，客户端与服务端的通信就开始了。</p>

<p><img src="../images/show-demo.png" alt="运行结果" /></p>

<h3 id="0x03-iremoteservice接口">0x03 IRemoteService接口</h3>

<p>系统自动生成的这个文件中有除了我们定义<code class="highlighter-rouge">getText()</code>方法外还生成了两个内部类<code class="highlighter-rouge">Stub</code>和<code class="highlighter-rouge">Proxy</code>。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IRemoteService</span> <span class="kd">extends</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IInterface</span> <span class="o">{</span>
    <span class="cm">/**
     * Local-side IPC implementation stub class.
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Stub</span> <span class="kd">extends</span> <span class="n">Binder</span> <span class="kd">implements</span> <span class="n">IRemoteService</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">DESCRIPTOR</span> <span class="o">=</span> <span class="s">"net.angrycode.learnpro.IRemoteService"</span><span class="o">;</span>

        <span class="cm">/**
         * Construct the stub at attach it to the interface.
         */</span>
        <span class="kd">public</span> <span class="nf">Stub</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">attachInterface</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">DESCRIPTOR</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Cast an IBinder object into an net.angrycode.learnpro.IRemoteService interface,
         * generating a proxy if needed.
         */</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="n">IRemoteService</span> <span class="nf">asInterface</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IInterface</span> <span class="n">iin</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">queryLocalInterface</span><span class="o">(</span><span class="n">DESCRIPTOR</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(((</span><span class="n">iin</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">iin</span> <span class="k">instanceof</span> <span class="n">IRemoteService</span><span class="o">)))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="o">((</span><span class="n">IRemoteService</span><span class="o">)</span> <span class="n">iin</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">IRemoteService</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">Proxy</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">IBinder</span> <span class="nf">asBinder</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onTransact</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">,</span> <span class="n">Parcel</span> <span class="n">data</span><span class="o">,</span> <span class="n">Parcel</span> <span class="n">reply</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">code</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">case</span> <span class="nl">INTERFACE_TRANSACTION:</span> <span class="o">{</span>
                    <span class="n">reply</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">DESCRIPTOR</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">case</span> <span class="nl">TRANSACTION_getText:</span> <span class="o">{</span>
                    <span class="n">data</span><span class="o">.</span><span class="na">enforceInterface</span><span class="o">(</span><span class="n">DESCRIPTOR</span><span class="o">);</span>
                    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">_result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
                    <span class="n">reply</span><span class="o">.</span><span class="na">writeNoException</span><span class="o">();</span>
                    <span class="n">reply</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">_result</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onTransact</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">reply</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Proxy</span> <span class="kd">implements</span> <span class="n">IRemoteService</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="n">IBinder</span> <span class="n">mRemote</span><span class="o">;</span>

            <span class="n">Proxy</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IBinder</span> <span class="n">remote</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mRemote</span> <span class="o">=</span> <span class="n">remote</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IBinder</span> <span class="nf">asBinder</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">mRemote</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getInterfaceDescriptor</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">DESCRIPTOR</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getText</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
                <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">_data</span> <span class="o">=</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
                <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">_reply</span> <span class="o">=</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
                <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">_result</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">_data</span><span class="o">.</span><span class="na">writeInterfaceToken</span><span class="o">(</span><span class="n">DESCRIPTOR</span><span class="o">);</span>
                    <span class="n">mRemote</span><span class="o">.</span><span class="na">transact</span><span class="o">(</span><span class="n">Stub</span><span class="o">.</span><span class="na">TRANSACTION_getText</span><span class="o">,</span> <span class="n">_data</span><span class="o">,</span> <span class="n">_reply</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                    <span class="n">_reply</span><span class="o">.</span><span class="na">readException</span><span class="o">();</span>
                    <span class="n">_result</span> <span class="o">=</span> <span class="n">_reply</span><span class="o">.</span><span class="na">readString</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">_reply</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
                    <span class="n">_data</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">_result</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TRANSACTION_getText</span> <span class="o">=</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IBinder</span><span class="o">.</span><span class="na">FIRST_CALL_TRANSACTION</span> <span class="o">+</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getText</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">RemoteException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Stub</code>类继承于<code class="highlighter-rouge">Binder</code>，但它们都实现了<code class="highlighter-rouge">IRemoteService</code>接口。</p>

<p><code class="highlighter-rouge">Binder</code>是何物呢？</p>

<blockquote>
  <p>Base class for a remotable object, the core part of a lightweight remote procedure call mechanism defined by Binder.This class is an implementation of IBinder that provides standard local implementation of such an object.</p>
</blockquote>

<p>可以看出<code class="highlighter-rouge">Binder</code>是一个远程对象，它实现了提供本地标准接口的<code class="highlighter-rouge">IBinder</code>。</p>

<p><img src="../images/stub-proxy.png" alt="Stub-Proxy" /></p>

<p><strong><code class="highlighter-rouge">Stub</code>类代表着远程服务，而<code class="highlighter-rouge">Proxy</code>代表着远程服务在本地的代理。</strong></p>

<h3 id="0x04-获取binder对象">0x04 获取Binder对象</h3>

<p>在客户端<code class="highlighter-rouge">MainActivity</code>中，绑定远程服务之后，使用<code class="highlighter-rouge">IRemoteService.Stub.asInterface()</code>方法获取到远程服务的<code class="highlighter-rouge">Binder</code>对象。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Cast an IBinder object into an net.angrycode.learnpro.IRemoteService interface,
 * generating a proxy if needed.
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">net</span><span class="o">.</span><span class="na">angrycode</span><span class="o">.</span><span class="na">learnpro</span><span class="o">.</span><span class="na">IRemoteService</span> <span class="nf">asInterface</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IBinder</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IInterface</span> <span class="n">iin</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">queryLocalInterface</span><span class="o">(</span><span class="n">DESCRIPTOR</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(((</span><span class="n">iin</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">iin</span> <span class="k">instanceof</span> <span class="n">net</span><span class="o">.</span><span class="na">angrycode</span><span class="o">.</span><span class="na">learnpro</span><span class="o">.</span><span class="na">IRemoteService</span><span class="o">)))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">((</span><span class="n">net</span><span class="o">.</span><span class="na">angrycode</span><span class="o">.</span><span class="na">learnpro</span><span class="o">.</span><span class="na">IRemoteService</span><span class="o">)</span> <span class="n">iin</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">net</span><span class="o">.</span><span class="na">angrycode</span><span class="o">.</span><span class="na">learnpro</span><span class="o">.</span><span class="na">IRemoteService</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">Proxy</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这个方法先查找本地是否存在这个对象，存在则返回；不存在则返回一个<code class="highlighter-rouge">Proxy</code>对象。</p>

<p>通过定点调试，可以知道当<code class="highlighter-rouge">RemoteService</code>在子进程中时，<code class="highlighter-rouge">asInterface(obj)</code>参数是一个<code class="highlighter-rouge">BinderProxy</code>对象，这个是远程服务进程的代理类。这个时候返回给客户端的是<code class="highlighter-rouge">Proxy</code>对象。</p>

<p><img src="../images/binder-asinterface.png" alt="binder-asinterface" /></p>

<p><strong>客户端与服务端不在同一进程时，通过<code class="highlighter-rouge">BinderProxy</code>进行通信</strong>。</p>

<p>当把<code class="highlighter-rouge">manifest</code>中<code class="highlighter-rouge">RemoteService</code>的<code class="highlighter-rouge">android:process=':remote'</code>配置去掉时，<code class="highlighter-rouge">asInterface(obj)</code>的参数的传递就是<code class="highlighter-rouge">RemoteService$1</code>，其实就是<code class="highlighter-rouge">RemoteService</code>里面的内部类<code class="highlighter-rouge">Stub</code>。</p>

<p><img src="../images/binder-remoteservice.png" alt="同进程中的IBinder对象就是RemoteService" /></p>

<p>然后我们再回到多进程的流程来，跳转到<code class="highlighter-rouge">Proxy</code>中</p>

<h3 id="0x05-proxytransact">0x05 Proxy.transact()</h3>

<p>通过名字知道<code class="highlighter-rouge">Proxy</code>就是远程服务的代理，它持有<code class="highlighter-rouge">Binder</code>的引用。当客户端调用<code class="highlighter-rouge">iRemoteService.getText()</code>时其实是进入到<code class="highlighter-rouge">Proxy</code>类中<code class="highlighter-rouge">getText()</code>方法。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getText</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">RemoteException</span> <span class="o">{</span>
    <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">_data</span> <span class="o">=</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
    <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">_reply</span> <span class="o">=</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">_result</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">_data</span><span class="o">.</span><span class="na">writeInterfaceToken</span><span class="o">(</span><span class="n">DESCRIPTOR</span><span class="o">);</span>
        <span class="n">mRemote</span><span class="o">.</span><span class="na">transact</span><span class="o">(</span><span class="n">Stub</span><span class="o">.</span><span class="na">TRANSACTION_getText</span><span class="o">,</span> <span class="n">_data</span><span class="o">,</span> <span class="n">_reply</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">_reply</span><span class="o">.</span><span class="na">readException</span><span class="o">();</span>
        <span class="n">_result</span> <span class="o">=</span> <span class="n">_reply</span><span class="o">.</span><span class="na">readString</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">_reply</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
        <span class="n">_data</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">_result</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>首先获取到两个<code class="highlighter-rouge">Parcel</code>对象，这个是进程间通信的数据结构。<code class="highlighter-rouge">_data</code>和<code class="highlighter-rouge">_reply</code>分别为<code class="highlighter-rouge">getText()</code>需要传递的参数和返回值，<code class="highlighter-rouge">getText()</code>无需参数，只有<code class="highlighter-rouge">String</code>类型返回值。</p>

<p>然后调用<code class="highlighter-rouge">mRemote</code>的<code class="highlighter-rouge">transact()</code>方法(其实就是调用<code class="highlighter-rouge">BinderProxy</code>的<code class="highlighter-rouge">transact()</code>方法)。然后通过<code class="highlighter-rouge">_reply</code>获取到执行方法后的返回值，这里就是一个<code class="highlighter-rouge">RemoteService</code>里面实现的<code class="highlighter-rouge">String</code>。</p>

<p><strong>在<code class="highlighter-rouge">Proxy</code>中执行<code class="highlighter-rouge">transact()</code>方法后又回调到哪里了呢？</strong></p>

<p>在<code class="highlighter-rouge">onTransact()</code>方法中设置一个断点，通过调试，我们发现其实是<strong>回调到了<code class="highlighter-rouge">Stub</code>类中<code class="highlighter-rouge">onTransact()</code>方法</strong>。</p>

<h3 id="0x06-stubontransact">0x06 Stub.onTransact()</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onTransact</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">,</span> <span class="n">Parcel</span> <span class="n">data</span><span class="o">,</span> <span class="n">Parcel</span> <span class="n">reply</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">code</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">case</span> <span class="nl">INTERFACE_TRANSACTION:</span> <span class="o">{</span>
                    <span class="n">reply</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">DESCRIPTOR</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">case</span> <span class="nl">TRANSACTION_getText:</span> <span class="o">{</span>
                    <span class="n">data</span><span class="o">.</span><span class="na">enforceInterface</span><span class="o">(</span><span class="n">DESCRIPTOR</span><span class="o">);</span>
                    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">_result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
                    <span class="n">reply</span><span class="o">.</span><span class="na">writeNoException</span><span class="o">();</span>
                    <span class="n">reply</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">_result</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onTransact</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">reply</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
        <span class="o">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">onTransact()</code>方法中第一个参数<code class="highlighter-rouge">code</code>是与<code class="highlighter-rouge">transact()</code>第一个参数<code class="highlighter-rouge">code</code>是对应的，这是客户端与服务端约定好的常量。</p>

<p>这时候会执行到<code class="highlighter-rouge">onTransact()</code>方法中的<code class="highlighter-rouge">_result = this.getText()</code>方法。而<code class="highlighter-rouge">Stub</code>类是在<code class="highlighter-rouge">RemoteService</code>中实现的，故就访问到远程服务中资源了。</p>

<h3 id="0x07-总结">0x07 总结</h3>

<p>通过以上流程分析可以知道，通过<code class="highlighter-rouge">bindService</code>绑定一个服务之后在<code class="highlighter-rouge">onServiceConnected()</code>中拿到了远程服务的在本地的<code class="highlighter-rouge">Proxy</code>，通过它与远程服务进行通信。</p>

<p><img src="../images/binder-flow.png" alt="Binder在App中的流程" /></p>


        
        <div class="post_footer">
          <p>Published on Aug 20, 2017 in categories 
          
          <a href="http://localhost:4000/categories/#Android" title="Android">Android</a>&nbsp;
          
          <p>
        </div>
        
        <ul class="prev_next">
            
            <li>
                <span>上一篇</span>
                <a href="/logisitic-regression">机器学习之逻辑回归</a>
            </li>
            
            
            <li>
                <span>下一篇</span>
                <a href="/awesome-blockchain-articles">【干货】入门区块链技术看这里就够了</a>
            </li>
            
        </ul>
        <hr>
<div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

        

  

  
        <div id="container"></div>
        <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
        <script src="http://localhost:4000/js/gitment.browser.js"></script>
        <script>
        var gitment = new Gitment({
            id: '/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%BB%8EAIDL%E7%9C%8BBinder%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E7%9A%84%E6%B5%81%E7%A8%8B',
            owner: 'hylinux1024',
            repo: 'hylinux1024.github.io',
            oauth: {
                client_id: 'c79c9ae57765adcce459',
                client_secret: '09264b1c3c58033878872c924196898c9931a8e5',
            },
        })
        gitment.render('container')
        </script>
  


    </div>
</div>
<center><p style="font-size:0.5em;">Powered by <a href="http://jekyllrb.com">Jekyll</a> and Theme by <a href="http://github.com/mzlogin/jekyll-theme-solid">solid</a></p></center>
    </body>
</html>

